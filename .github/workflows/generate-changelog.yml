name: Generate changelog file

on:
  workflow_run:
    workflows: ["Create release"] # The exact name of your release workflow
    types:
      - completed

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Generate release changelog
        id: changelog
        uses: janheinrichmerker/action-github-changelog-generator@v2.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          verbose: true
      - name: Diagnostic info
        run: |
          echo  "pwd= $(pwd)"
          sudo chmod 666 CHANGELOG.md
          ls -lA
          touch CHANGELOG.md
      - name: Save changelog to file
        run: |
          printf 'Changelog file generated automatically. Do not edit.\n' > CHANGELOG.md
          printf 'Changelog generated at: %s\n' "$(date --iso-8601=seconds)" >> CHANGELOG.md
          printf '%s\n' "${{ steps.changelog.outputs.changelog }}" >> CHANGELOG.md
      
      - name: Commit changelog
        uses: EndBug/add-and-commit@v7
        with:
          author_name: github-actions
          author_email: github-actions@github.com
          message: "robot: update CHANGELOG.md ${{ vars.REPO_VAR_TAG }}"
          add: 'CHANGELOG.md'
          push: false # do not push yet because main branch is protected and require PR
      
      - name: Create Pull Request for changelog to main branch
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: changelog-update-${{ vars.REPO_VAR_TAG }}
          title: "Update changelog ${{ vars.REPO_VAR_TAG }}"
          body: "Automated changelog update ${{ vars.REPO_VAR_TAG }}"
          base: main
