name: Generate changelog file

on:
  pull_request:
    branches:
      - main
    types:
      - opened

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          ref: ${{ github.head_ref }}

      - name: Generate release changelog
        id: changelog
        uses: janheinrichmerker/action-github-changelog-generator@v2.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          verbose: true
      - name: Save changelog to file
        run: |
          sudo chmod 666 CHANGELOG.md
          printf 'Changelog file generated automatically. Do not edit.\n' > CHANGELOG.md
          printf 'Changelog generated at: %s\n' "$(date --iso-8601=seconds)" >> CHANGELOG.md
          printf '%s\n' "${{ steps.changelog.outputs.changelog }}" >> CHANGELOG.md
      
      - name: Commit changelog update
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "ci: changelog file automatic update"
          git push origin HEAD:${{ github.head_ref }}
